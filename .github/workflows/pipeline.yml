name: CI-CD Pipeline to kubernetes

on:
  push:
    branches: 
      - main
      - master

jobs:
  build-and-deploy: # Unified into one job for simplicity
    runs-on: ubuntu-latest
    steps:
      - name: checkout code
        uses: actions/checkout@v3

      - name: Docker Login
        run: echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin

      - name: Build Docker Image
        run: docker build -t ${{ secrets.DOCKER_USERNAME }}/k8s-devops-project .

      - name: Push Docker Image
        run: docker push ${{ secrets.DOCKER_USERNAME }}/k8s-devops-project

      # HACK 1: Create a real K8s cluster inside the GitHub Runner
      - name: Create Kubernetes Cluster (Kind)
        uses: helm/kind-action@v1.10.0
        with:
          cluster_name: kind-cluster

      # HACK 2: "Load" the image into Kind so K8s can see it locally
      - name: Load Image to Kind
        run: kind load docker-image ${{ secrets.DOCKER_USERNAME }}/k8s-devops-project --name kind-cluster

      - name: set up kubectl
        uses: azure/setup-kubectl@v3

      # TRICK: Always verify the cluster is up before applying
      - name: Check Cluster Info
        run: kubectl cluster-info

      - name: Deploy to Kubernetes
        run: |
          kubectl apply -f k8s/deployment.yaml
          kubectl apply -f k8s/service.yaml
          
      # OPTIONAL: Wait for deployment to ensure it actually works
      - name: Verify Deployment
        run: kubectl rollout status deployment/your-deployment-name --timeout=60s